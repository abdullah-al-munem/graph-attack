import os
import logging
import warnings
import pandas as pd
import ast

from proposed_attack_model import start_attack_proposed_model
from utils import get_dataset_from_deeprobust, get_target_node_list, get_miss_classification_original_dataset
from state_of_the_art_attack_models import start_attack_IGAttack, start_attack_SGAttack

warnings.simplefilter('ignore')

log_file_name = "./all_attack.log"

# Check if the file exists
if os.path.exists(log_file_name):
    if os.path.exists(f"{log_file_name}.bak"):
        os.remove(f"{log_file_name}.bak")
    os.rename(log_file_name, f"{log_file_name}.bak")
    # Remove the original file
    # os.remove(f"{log_file_name}")

# Configure logging to both console and file
logging.basicConfig(level=logging.DEBUG,
                    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
                    handlers=[
                        logging.StreamHandler(),  # Log to console
                        logging.FileHandler(log_file_name)  # Log to a file
                    ])

# Create a logger
logger = logging.getLogger(__name__)
logger.info('All attacks has been started...')


if __name__ == "__main__": 

    '''
    Todo List:

    1. cora-gcn (done.) 
    2. cora-gin (done.)
    3. cora-gat
    4. cora-graphsage

    5. citeseer-gcn (done.)
    6. citeseer-gin
    7. citeseer-gat
    8. citeseer-graphsage

    9. polblogs-gcn (done.)
    10. polblogs-gin
    11. polblogs-gat
    12. polblogs-graphsage
    '''

    defense_model_list = ['gcn', 'gin', 'gat', 'graphsage']
    dataset_list = ['cora', 'citeseer', 'polblogs']

    surrogate_model = 'gcn'
    dataset = 'citeseer'
    defense_model = 'gin'

    data = get_dataset_from_deeprobust(dataset=dataset)
    print("Dataset loaded...")
    budget_range = 7

    times = 5

    file_list = os.listdir('./')
    # print(csv_file_list)

    # cora-gcn
    # all_node_list = [
    #     [929, 1554, 1504, 1163, 1342, 2406, 2307, 1185, 1347, 2260, 2341, 448, 1800, 1725, 2057, 136, 1995, 530, 1559, 941, 838, 1079, 1860, 477, 6, 836, 479, 2345, 1074, 1143, 2060, 545, 336, 1230, 1546, 231, 1254, 1397, 496, 1476],
    #     [929, 1554, 1504, 1163, 2082, 2307, 1185, 2406, 1820, 1639, 746, 2057, 2467, 1817, 682, 1276, 485, 1620, 368, 1908, 2075, 2100, 454, 332, 1607, 989, 730, 2124, 868, 426, 248, 173, 2251, 1254, 1872, 1683, 2006, 2256, 1904, 1924],
    #     [929, 1554, 1504, 1342, 2406, 1347, 1163, 1185, 1822, 838, 1582, 1591, 498, 1206, 1599, 2467, 1368, 2372, 124, 594, 2442, 173, 1479, 84, 2366, 1664, 405, 1192, 1588, 559, 1796, 1758, 1126, 855, 366, 1999, 122, 928, 1490, 2013],
    #     [929, 1554, 1504, 1342, 1347, 1163, 2406, 1820, 1185, 1779, 2155, 512, 745, 742, 320, 1583, 1744, 205, 440, 134, 1062, 13, 1751, 1073, 901, 44, 1811, 642, 1815, 2060, 624, 1158, 2192, 1176, 1441, 2217, 517, 2455, 2057, 603],
    #     [929, 1554, 1504, 838, 1342, 1347, 1820, 1163, 1185, 2307, 111, 2016, 1306, 1760, 73, 167, 1502, 2199, 169, 1120, 994, 1027, 1035, 401, 2010, 1898, 950, 1287, 1739, 1884, 9, 1200, 693, 2119, 11, 1490, 1048, 327, 2319, 2064],
    # ]

    ## cora-gat
    # all_node_list = [
    #     [929, 1163, 1342, 2082, 2406, 1049, 2007, 1347, 1820, 1504, 284, 145, 620, 764, 1498, 2134, 1700, 2475, 1324, 831, 1895, 123, 689, 1537, 1708, 1787, 1866, 836, 294, 1311, 985, 216, 1118, 1719, 1358, 1028, 1856, 43, 1855, 2001],
    #     [929, 1163, 1342, 2406, 1820, 1347, 1504, 2082, 1049, 2292, 831, 1388, 135, 2019, 1577, 2358, 2268, 1092, 181, 1853, 1989, 487, 1469, 1679, 317, 673, 236, 549, 1585, 2265, 1992, 1349, 247, 1124, 1659, 1552, 1424, 472, 1537, 2365],
    #     [1342, 2406, 1347, 929, 1820, 2082, 1049, 2007, 1163, 1340, 2016, 2133, 328, 1498, 1784, 504, 53, 2178, 974, 1517, 2478, 1004, 325, 1715, 517, 519, 2248, 1452, 1239, 2483, 1674, 2100, 645, 1574, 2078, 2371, 1152, 462, 2411, 945],
    #     [1347, 2082, 1820, 1342, 2406, 1163, 2007, 1822, 1049, 929, 284, 1929, 620, 2199, 2218, 1417, 143, 1623, 1552, 663, 485, 2328, 1873, 952, 707, 235, 405, 1016, 2031, 1201, 2067, 2359, 1262, 1695, 2302, 1310, 250, 2012, 1478, 382],
    #     [2082, 929, 1049, 1342, 1163, 2406, 1347, 2096, 1820, 1504, 1839, 82, 2298, 25, 1763, 2358, 649, 179, 304, 1227, 1184, 780, 2388, 1695, 1935, 210, 1189, 273, 247, 1470, 2301, 2260, 1144, 423, 98, 132, 1909, 490, 1001, 115]
    # ]

    # ### cora-gin

    # all_node_list = [
    #     [1554, 929, 1163, 1342, 1347, 2102, 2307, 2260, 2082, 1340, 2154, 1585, 1690, 1173, 1290, 1677, 677, 321, 1853, 2135, 1594, 2167, 1378, 1990, 2469, 2429, 1448, 538, 391, 2443, 1523, 319, 1741, 1944, 214, 996, 1217, 745, 1215, 1828],
    #     [1554, 929, 1342, 1347, 2102, 1163, 1541, 1340, 2082, 2007, 1318, 124, 441, 422, 640, 2020, 2155, 2380, 1839, 1978, 455, 529, 917, 2435, 1278, 2283, 304, 94, 1907, 182, 1718, 1116, 1272, 1173, 372, 1563, 406, 655, 926, 1938], 
    #     [1554, 929, 1342, 1163, 1347, 2007, 2102, 2082, 683, 2346, 321, 444, 2146, 1659, 975, 1207, 1220, 1979, 2299, 1658, 162, 877, 2438, 1627, 2244, 2256, 1045, 131, 2000, 1074, 526, 1025, 1320, 2348, 1727, 1156, 881, 1956, 1546, 455],
    #     [1554, 1504, 2082, 2406, 1342, 1049, 1347, 2007, 1669, 2077, 993, 2140, 602, 2085, 881, 896, 935, 2420, 172, 1315, 131, 2414, 1695, 2323, 1948, 517, 402, 2292, 547, 1080, 356, 34, 944, 757, 1781, 183, 2016, 2136, 2418, 189],
    #     [1554, 2007, 2082, 1049, 2077, 1021, 1823, 1347, 683, 2406, 1095, 1306, 764, 2340, 219, 2323, 746, 39, 2299, 488, 2361, 2302, 618, 1661, 473, 1478, 2286, 540, 708, 777, 2298, 2398, 1898, 1358, 2130, 173, 1985, 1194, 1778, 2229],
    # ]

    # ### cora-graphsage

    # all_node_list = [
    #     [929, 1554, 1342, 1347, 1820, 2406, 1504, 1340, 2077, 1049, 600, 172, 1148, 2469, 2369, 2065, 300, 736, 1383, 2316, 1722, 160, 1684, 877, 1697, 1311, 1501, 2042, 1288, 1425, 1944, 40, 1954, 20, 1977, 100, 444, 1002, 1407, 734],
    #     [1554, 929, 1342, 1347, 1820, 1049, 1340, 2406, 2077, 1504, 251, 752, 436, 769, 409, 39, 608, 195, 1206, 480, 1613, 1215, 483, 1801, 104, 1455, 1448, 2362, 1876, 2073, 1648, 804, 1232, 2191, 2354, 526, 1416, 1618, 360, 1137], 
    #     [1554, 929, 1342, 1347, 1820, 2406, 1340, 1005, 1504, 2007, 1206, 1083, 1218, 679, 1869, 442, 771, 1108, 436, 2085, 1145, 2151, 355, 2367, 1355, 88, 1276, 1310, 1040, 593, 1044, 838, 1874, 2041, 252, 2157, 529, 1138, 1253, 344],
    #     [1554, 929, 1342, 1347, 2406, 1820, 2007, 1340, 1049, 1504, 2199, 1220, 2323, 960, 1674, 119, 1511, 914, 689, 1654, 2127, 1858, 158, 1427, 260, 970, 952, 1448, 1259, 1684, 997, 1310, 2347, 89, 2218, 1547, 216, 1075, 112, 1076],
    #     [929, 1342, 1347, 2406, 1340, 1820, 1504, 1255, 1554, 1049, 442, 2063, 552, 2014, 2380, 2338, 1343, 480, 1580, 928, 746, 1998, 2084, 169, 1977, 1801, 948, 18, 1747, 479, 321, 674, 1957, 1673, 1904, 1096, 774, 1170, 1948, 1764],
    # ]


    # ### citeseer_gcn
    # all_node_list = [
    #     [862, 1750, 1333, 1218, 1778, 1388, 688, 1687, 1904, 1694, 1262, 110, 217, 1325, 1929, 1384, 1270, 573, 775, 703, 590, 1360, 1196, 1913, 387, 712, 434, 1323, 627, 907, 347, 1241, 1990, 2059, 1192, 436, 1597, 887, 1542, 429],
    #     [862, 1750, 1388, 1694, 1904, 817, 1687, 2055, 1137, 1038, 1606, 1448, 81, 647, 1007, 1008, 2029, 917, 1159, 1169, 1037, 857, 858, 441, 16, 1903, 1148, 830, 687, 729, 1534, 852, 1777, 1216, 1174, 677, 1481, 2041, 524, 1924],
    #     [862, 1750, 817, 1320, 1388, 1452, 1453, 2055, 1289, 1137, 1893, 2072, 516, 1925, 168, 526, 93, 1435, 147, 66, 362, 95, 1442, 709, 1694, 228, 146, 1444, 1314, 1385, 60, 605, 1898, 115, 144, 554, 355, 1717, 713, 1051],
    #     [1750, 862, 1706, 1388, 1687, 888, 649, 1904, 817, 1311, 784, 812, 1563, 1731, 1625, 2029, 329, 555, 1831, 93, 1582, 69, 1963, 1432, 636, 1217, 2039, 2006, 1226, 966, 508, 724, 1331, 462, 908, 374, 2012, 1099, 414, 1011],
    #     [862, 1750, 817, 1452, 1320, 1388, 354, 1289, 1554, 1453, 1125, 319, 1952, 2040, 365, 1897, 1848, 784, 873, 191, 370, 362, 2021, 1378, 1119, 631, 2076, 847, 1992, 1586, 731, 470, 1892, 867, 1697, 1220, 2057, 376, 1924, 1295],
    # ]

    ### citeseer_gin
    all_node_list = [
        [862, 1750, 1348, 1687, 1388, 1311, 938, 1333, 2062, 817, 1224, 1792, 185, 329, 824, 1819, 308, 1230, 730, 1296, 1481, 58, 1443, 898, 455, 1099, 1987, 880, 1413, 2108, 1079, 1556, 1205, 1372, 63, 757, 300, 321, 21, 280],
        [1750, 862, 2097, 1311, 1880, 1388, 941, 1687, 1575, 238, 1815, 784, 379, 1699, 973, 48, 159, 2011, 329, 1362, 847, 375, 1398, 1409, 1616, 533, 16, 1282, 1914, 2054, 670, 1572, 853, 1780, 1295, 932, 1857, 465, 1688, 1304],
        [862, 1750, 1348, 1388, 1687, 885, 1706, 1311, 2062, 354, 328, 1977, 101, 1059, 262, 1640, 1663, 1543, 1869, 1965, 371, 912, 1114, 1597, 1756, 2057, 1699, 738, 878, 1914, 282, 1538, 355, 208, 716, 597, 1337, 1211, 110, 323],
        [1750, 1904, 1905, 1333, 1843, 1801, 1348, 1747, 862, 1988, 1364, 413, 1561, 1598, 1537, 1033, 110, 397, 826, 345, 735, 1687, 1735, 1567, 1088, 783, 214, 1039, 1545, 1222, 437, 15, 1341, 1230, 608, 1817, 1899, 1771, 442, 355],
        [862, 1750, 1582, 2094, 1904, 1905, 1454, 885, 2099, 938, 1810, 1890, 974, 864, 2021, 984, 1127, 917, 1734, 443, 1291, 1611, 1047, 1716, 533, 1129, 207, 15, 496, 398, 860, 1015, 376, 482, 557, 408, 798, 1192, 1828, 1203],
    ]

    # ### polblogs-gcn
    # all_node_list = [
    #     [671, 47, 282, 357, 496, 339, 83, 881, 118, 444, 844, 894, 641, 389, 301, 948, 720, 468, 615, 62, 180, 638, 328, 482, 261, 637, 774, 354, 576, 215, 1127, 216, 944, 1167, 105, 690, 742, 1071, 785, 704],
    #     [47, 496, 357, 282, 339, 444, 252, 118, 83, 383, 574, 509, 537, 531, 173, 323, 1019, 267, 1018, 207, 308, 1136, 249, 81, 1114, 944, 123, 130, 683, 848, 454, 746, 601, 983, 951, 609, 34, 896, 657, 844],
    #     [671, 47, 282, 357, 496, 881, 339, 921, 83, 444, 1019, 301, 62, 1018, 942, 720, 106, 844, 640, 641, 1100, 839, 697, 285, 634, 64, 690, 1006, 745, 1105, 1044, 530, 1028, 1184, 323, 928, 725, 313, 638, 103],
    #     [671, 47, 282, 496, 357, 339, 881, 83, 118, 921, 1054, 62, 888, 1158, 942, 106, 2, 389, 1019, 49, 169, 731, 787, 723, 616, 927, 166, 502, 644, 773, 149, 305, 549, 86, 147, 612, 332, 343, 112, 1202],
    #     [671, 47, 496, 357, 282, 339, 83, 118, 881, 444, 341, 544, 641, 948, 62, 301, 640, 833, 709, 615, 910, 19, 575, 32, 753, 702, 1184, 1104, 142, 992, 667, 824, 882, 319, 1002, 870, 397, 966, 1069, 63],
    # ]

    

    for time in range(1, times+1):
        # print(f"Running attacks for {time} time(s)......")
        # print(f"Proposed model started...")
        flg_proposed, flg_sgattack, flg_igattack, flg_fga = 1, 1, 1, 1
        csv_file_list = [file for file in file_list if ('.csv' in  file) and (str(time) in file)]

        for file in csv_file_list:
            _model = file[:-4].split('_')[0]
            _time = int(file[:-4].split('_')[-1])

            if _time == time and _model.lower() == 'proposed':
                flg_proposed = 0
            # if _time == time and _model.lower() == 'sgattack':
            #     flg_sgattack = 0
            # if _time == time and _model.lower() == 'igattack':
            #     flg_igattack = 0
            # if _time == time and _model.lower() == 'fga':
            #     flg_fga = 0

        logger.info(f"Running attacks for {time} time(s)......")

        # if not (flg_sgattack or flg_igattack or flg_fga):
        #     continue
        if not (flg_proposed):
            continue

        node_list = all_node_list[time-1]

        print(node_list)
        logger.info(f"Node list: {node_list}")
        # exit()
        # node_list = [929, 1163, 1347, 2077, 2082, 1049, 1185, 2260, 1669, 1486, 1104, 2429, 1207, 1068, 1891, 2379, 720, 2323, 2200, 1167, 1924, 1180, 413, 832, 2148, 159, 1878, 2481, 1448, 1745, 1505, 1547, 1938, 805, 354, 1321, 97, 811, 72, 366]
        
        # print("Targegt nodes are being selected...")
        logger.info(f"Targegt nodes are being selected...")

        # get_miss_classification_original_dataset(defense_model, dataset, node_list, time)

        if flg_proposed:
            logger.info(f"Proposed model attack has started...")
            start_attack_proposed_model(surrogate_model, dataset, defense_model, budget_range, node_list, time)

        # if flg_sgattack:
        #     logger.info(f"SGAttack attack has started...")
        #     start_attack_SGAttack(dataset, defense_model, budget_range, node_list, time)

        # if flg_igattack:
        #     logger.info(f"IGAttack has started...")
        #     start_attack_IGAttack(dataset, defense_model, budget_range, node_list, time)

        # if flg_nettack:
        #     logger.info(f"Nettack has started...")
        #     start_attack_Nettack(dataset, defense_model, budget_range, node_list, time)


